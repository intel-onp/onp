#jinja2: lstrip_blocks: True
#!/bin/bash

# Copyright (c) 2017, Intel Corporation
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#On one storage host prepare rings:
KOLLA_STORAGE_INTERNAL_ADDRESSES="{% for host in groups['storage'] %}{{ node_info[host].networks['mgmt'].ip_address }} {% endfor %}"
KOLLA_BASE_DISTRO={{ kolla_base_distro }}
KOLLA_INSTALL_TYPE={{ kolla_install_type }}
KOLLA_REGISTRY="{{ docker_registry }}/{{ docker_namespace }}/"
KOLLA_TAG=":{{ openstack_release }}"

# Object ring
docker run --rm\
  -v /etc/kolla/config/swift/:/etc/kolla/config/swift/ \
  ${KOLLA_REGISTRY}${KOLLA_BASE_DISTRO}-${KOLLA_INSTALL_TYPE}-swift-base${KOLLA_TAG} \
  swift-ring-builder /etc/kolla/config/swift/object.builder create 10 3 1

for KOLLA_INTERNAL_ADDRESS in $KOLLA_STORAGE_INTERNAL_ADDRESSES; do
  docker run --rm\
    -v /etc/kolla/config/swift/:/etc/kolla/config/swift/ \
    ${KOLLA_REGISTRY}${KOLLA_BASE_DISTRO}-${KOLLA_INSTALL_TYPE}-swift-base${KOLLA_TAG} swift-ring-builder \
    /etc/kolla/config/swift/object.builder add r1z1-${KOLLA_INTERNAL_ADDRESS}:6000/d0 1;
done

# Account ring
docker run --rm\
  -v /etc/kolla/config/swift/:/etc/kolla/config/swift/ \
  ${KOLLA_REGISTRY}${KOLLA_BASE_DISTRO}-${KOLLA_INSTALL_TYPE}-swift-base${KOLLA_TAG} \
  swift-ring-builder /etc/kolla/config/swift/account.builder create 10 3 1

for KOLLA_INTERNAL_ADDRESS in $KOLLA_STORAGE_INTERNAL_ADDRESSES; do
  docker run --rm\
    -v /etc/kolla/config/swift/:/etc/kolla/config/swift/ \
    ${KOLLA_REGISTRY}${KOLLA_BASE_DISTRO}-${KOLLA_INSTALL_TYPE}-swift-base${KOLLA_TAG} swift-ring-builder \
    /etc/kolla/config/swift/account.builder add r1z1-${KOLLA_INTERNAL_ADDRESS}:6001/d0 1;
done

# Container ring
docker run --rm\
  -v /etc/kolla/config/swift/:/etc/kolla/config/swift/ \
  ${KOLLA_REGISTRY}${KOLLA_BASE_DISTRO}-${KOLLA_INSTALL_TYPE}-swift-base${KOLLA_TAG} \
  swift-ring-builder /etc/kolla/config/swift/container.builder create 10 3 1

for KOLLA_INTERNAL_ADDRESS in $KOLLA_STORAGE_INTERNAL_ADDRESSES; do
  docker run --rm\
    -v /etc/kolla/config/swift/:/etc/kolla/config/swift/ \
    ${KOLLA_REGISTRY}${KOLLA_BASE_DISTRO}-${KOLLA_INSTALL_TYPE}-swift-base${KOLLA_TAG} swift-ring-builder \
    /etc/kolla/config/swift/container.builder add r1z1-${KOLLA_INTERNAL_ADDRESS}:6002/d0 1;
done
for ring in object account container; do
  docker run --rm\
    -v /etc/kolla/config/swift/:/etc/kolla/config/swift/ \
    ${KOLLA_REGISTRY}${KOLLA_BASE_DISTRO}-${KOLLA_INSTALL_TYPE}-swift-base${KOLLA_TAG} swift-ring-builder \
    /etc/kolla/config/swift/${ring}.builder rebalance;
done

#provide rings to kola-deploy container:
ls -l {{ kolla_deploy_config_dir }}/config/swift/
cp /etc/kolla/config/swift/*.ring.gz {{ kolla_deploy_config_dir }}/config/swift/
cp /etc/kolla/config/swift/*.builder {{ kolla_deploy_config_dir }}/config/swift/
echo "New swift rings:"
ls -l {{ kolla_deploy_config_dir }}/config/swift/
